- name: Install Argo CD on Kubernetes
  hosts: master
  become: yes
  tasks:
    - name: Create a namespace for Argo CD
      kubectl:
        name: argocd
        state: present
        api_version: v1
        kind: Namespace

    - name: Install Argo CD using kubectl
      shell: kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

    - name: Configure Git Repo
      shell: kubectl apply -n argocd -f secret.yml

    - name: Deploy argocd apps
      shell: kubectl apply -n argocd -f application.yaml

    - name: Wait for 120 seconds using sleep
      command: sleep 120
    
    - name: Extract Argo CD HTTPS port from Kubernetes service
      command: >
        kubectl get svc argocd-server -n argocd -o=jsonpath='{.spec.ports[1].nodePort}'
      register: argocd_https_port

    - name: Save the port number to a file
      copy:
        content: "{{ argocd_https_port.stdout }}"
        dest: "/tmp/argocd_https_port.txt"
        mode: '0644'

